# 问题诊断：检测不到打架

## 📋 您遇到的问题

运行检测后，所有指标都是0：

```
精确率 (Precision): 0.0000
召回率 (Recall):    0.0000
F1分数 (F1-Score):  0.0000
真正例 (TP):        0
假正例 (FP):        0
假负例 (FN):        3
```

这说明**完全没有检测到任何打架片段**。

---

## 🔍 可能的原因

### 原因1: 跟踪效果不好
- 模型没有检测到足够的目标（猪）
- 检测置信度太高，漏检了很多目标
- 跟踪器无法稳定跟踪目标

### 原因2: 阈值设置太严格
- `distance_threshold` 太小（默认100）
- `speed_threshold` 太大（默认50）
- 实际打架时的距离和速度不符合阈值

### 原因3: 窗口参数不合适
- `window_size` 太小或太大
- `min_fight_duration` 太大，过滤掉了所有片段

---

## 🚀 快速诊断（推荐）

我已经为您创建了一个**自动诊断工具**，它会：
1. 分析跟踪效果
2. 统计目标检测情况
3. 计算实际的距离和速度分布
4. 自动推荐合适的参数

### 运行诊断工具

```bash
python diagnose_detection.py \
    --weights runs/train/v10-APConv-AssemFormer-HSFPN-ATFLm_exp/weights/best.pt \
    --source test_videos/MyVideo_191.mp4 \
    --distance-threshold 100 \
    --speed-threshold 50
```

### 诊断报告示例

```
==================================================
[4] 跟踪结果分析
==================================================

目标检测统计:
  - 有检测到目标的帧数: 2850/3000 (95.0%)
  - 检测到2个或以上目标的帧数: 2600/3000 (86.7%)
  - 平均目标数: 3.2
  - 最大目标数: 5

跟踪ID统计:
  - 总共跟踪到的不同ID数: 8

==================================================
[5] 打架特征分析
==================================================

距离统计（目标间距离，像素）:
  - 平均距离: 285.3
  - 中位距离: 250.1
  - 小于100像素的比例: 8.5%    ← 很低！
  - 小于150像素的比例: 15.2%
  
  当前distance_threshold设置: 100
  → 符合当前阈值的距离比例: 8.5%  ← 太少了！
  
  ⚠️  警告: 只有很少的距离小于阈值！
     建议降低distance_threshold到: 180

速度统计（帧间位移，像素/帧）:
  - 平均速度: 12.5
  - 速度 > 50 的比例: 2.3%    ← 很低！
  
  当前speed_threshold设置: 50
  → 符合当前阈值的速度比例: 2.3%  ← 太少了！
  
  ⚠️  警告: 只有很少的速度大于阈值！
     建议降低speed_threshold到: 25

==================================================
[7] 推荐命令
==================================================

python track_with_fight_detection.py \
    --weights best.pt \
    --source test_videos/MyVideo_191.mp4 \
    --gt-file ground_truth_example.json \
    --fps 30 \
    --distance-threshold 180 \
    --speed-threshold 25 \
    --window-size 30 \
    --stride 10 \
    --min-fight-duration 10 \
    --show
```

---

## 🔧 手动排查步骤

如果不使用诊断工具，可以按以下步骤手动排查：

### 步骤1: 检查跟踪效果

```bash
python track.py \
    --weights runs/train/v10-APConv-AssemFormer-HSFPN-ATFLm_exp/weights/best.pt \
    --source test_videos/MyVideo_191.mp4 \
    --show
```

**观察**:
- ✓ 能稳定检测到猪吗？
- ✓ 跟踪ID是否稳定？（不频繁变化）
- ✓ 同时出现多只猪吗？

**如果检测效果不好**:
```bash
# 降低置信度阈值
python track.py --source ... --conf 0.5 --show
```

### 步骤2: 大幅降低所有阈值测试

```bash
python track_with_fight_detection.py \
    --weights runs/train/v10-APConv-AssemFormer-HSFPN-ATFLm_exp/weights/best.pt \
    --source test_videos/MyVideo_191.mp4 \
    --gt-file ground_truth_example.json \
    --fps 30 \
    --conf 0.5 \
    --distance-threshold 200 \
    --speed-threshold 20 \
    --min-fight-duration 5 \
    --stride 10 \
    --show
```

**如果还是检测不到**:
- 检查视频中是否真的有打架行为
- 检查GT标注是否正确
- 模型可能需要重新训练

**如果检测到了但误检很多**:
- 逐步提高阈值
- 增加 `min_fight_duration`

### 步骤3: 逐步调整参数

从宽松参数开始，逐步调整：

```bash
# 测试1: 极宽松
--distance-threshold 300 --speed-threshold 10

# 测试2: 宽松
--distance-threshold 200 --speed-threshold 25

# 测试3: 中等
--distance-threshold 150 --speed-threshold 35

# 测试4: 严格
--distance-threshold 100 --speed-threshold 50
```

记录每次的 Precision、Recall、F1，选择F1最高的参数组合。

---

## 📊 理解阈值含义

### distance_threshold（距离阈值）

**含义**: 两只猪中心点距离小于此值，判定为"接近"

**典型值**:
- 640×480视频: 60-150像素
- 1920×1080视频: 150-300像素

**调整原则**:
- 值太小 → 只有紧贴才算，容易漏检
- 值太大 → 只要靠近就算，容易误检

**如何确定**:
1. 打开打架视频
2. 截图测量打架时两只猪的距离
3. 设置为该距离的1.2倍

### speed_threshold（速度阈值）

**含义**: 目标帧间位移大于此值，判定为"剧烈运动"

**典型值**: 20-50像素/帧

**调整原则**:
- 值太小 → 正常走动也算，容易误检
- 值太大 → 只有快速移动才算，容易漏检

**影响因素**:
- 视频帧率（帧率越高，帧间位移越小）
- 猪的实际运动速度
- 视频分辨率

---

## ⚡ 常见场景及解决方案

### 场景1: 完全检测不到（FN = GT数量，TP = 0）

**症状**:
```
真正例 (TP): 0
假正例 (FP): 0
假负例 (FN): 3
```

**原因**: 阈值太严格或跟踪效果差

**解决**:
```bash
# 1. 运行诊断工具
python diagnose_detection.py --weights ... --source ...

# 2. 使用推荐参数重新运行
# 或大幅降低阈值:
--distance-threshold 200 --speed-threshold 20 --min-fight-duration 5
```

### 场景2: 检测到但全是误检（FP很多，TP = 0）

**症状**:
```
真正例 (TP): 0
假正例 (FP): 15
假负例 (FN): 3
```

**原因**: 阈值太宽松，时间对不上

**解决**:
```bash
# 1. 检查fps设置是否正确
ffprobe -v quiet -show_streams test_videos/MyVideo_191.mp4 | grep r_frame_rate

# 2. 提高阈值:
--distance-threshold 80 --speed-threshold 60 --min-fight-duration 20

# 3. 减小stride提高时间精度:
--stride 5
```

### 场景3: 部分检测到（TP > 0, FN > 0）

**症状**:
```
真正例 (TP): 1
假正例 (FP): 2
假负例 (FN): 2
```

**原因**: 参数接近最优，需微调

**解决**:
```bash
# 1. 可视化查看哪些片段检测对了，哪些错了
python visualize_results.py --video ... --pred ... --gt ...

# 2. 微调参数:
# - FN多（漏检） → 放宽阈值
# - FP多（误检） → 收紧阈值

# 3. 调整时间相关参数:
--stride 10  # 更细的时间粒度
--window-size 40  # 更大的观察窗口
```

---

## 📝 参数调优检查清单

在调参前，确认：

- [ ] 模型能稳定检测到猪（使用 `track.py --show` 验证）
- [ ] 视频fps设置正确
- [ ] GT文件中的视频名能匹配
- [ ] 运行过诊断工具（`diagnose_detection.py`）

调参时，按顺序调整：

1. [ ] 先确保能检测到打架（宽松阈值）
2. [ ] 再减少误检（收紧阈值）
3. [ ] 最后优化时间精度（调整stride和window_size）

---

## 🎯 推荐工作流程

```bash
# 1. 诊断（最重要！）
python diagnose_detection.py \
    --weights best.pt \
    --source test_videos/MyVideo_191.mp4

# 2. 使用诊断工具推荐的参数
python track_with_fight_detection.py \
    --weights best.pt \
    --source test_videos/MyVideo_191.mp4 \
    --gt-file ground_truth_example.json \
    --fps 30 \
    --distance-threshold <诊断推荐值> \
    --speed-threshold <诊断推荐值> \
    --show

# 3. 可视化验证
python visualize_results.py \
    --video test_videos/MyVideo_191.mp4 \
    --pred fight_detection_results/MyVideo_191_predictions.json \
    --gt ground_truth_example.json \
    --fps 30

# 4. 根据可视化结果微调参数，重复步骤2-3

# 5. 满意后，批量评估
python batch_evaluate.py \
    --weights best.pt \
    --video-dir ./test_videos \
    --gt-file ground_truth_example.json \
    --fps 30 \
    --distance-threshold <最优值> \
    --speed-threshold <最优值>
```

---

## 💡 重要提示

1. **必须先运行诊断工具**：它会告诉您当前视频的实际距离和速度分布
2. **阈值没有通用值**：不同视频、不同拍摄角度、不同分辨率都需要不同的阈值
3. **边看边调**：使用 `--show` 参数实时查看效果
4. **记录参数**：每次测试记录参数和F1分数，找到最优组合

---

## 📞 仍然有问题？

如果按照上述步骤操作后仍然检测不到，可能是：

1. **模型问题**: 模型无法检测到当前场景中的猪
   - 解决：使用更通用的模型或重新训练

2. **GT问题**: GT标注可能有误
   - 解决：使用 `test_gt_loading.py` 验证GT

3. **视频问题**: 视频质量太差或角度不适合
   - 解决：检查视频是否清晰、猪是否可见

4. **算法局限**: 当前基于距离+速度的规则可能不够
   - 解决：需要更复杂的算法或深度学习方法

---

**现在请先运行诊断工具，它会告诉您具体问题和推荐参数！** 🔍

