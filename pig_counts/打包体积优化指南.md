# PyInstaller 打包体积优化指南

## 当前问题
原打包命令使用了 `--collect-all` 参数，会收集所有依赖的全部文件，导致打包体积达到 5GB。

## 优化策略

### 1. 使用优化后的打包命令（已更新）
新命令移除了 `--collect-all` 参数，只包含必要的模块，预计可以减小到 **500MB-1GB**。

### 2. 进一步优化 - 创建 PyTorch CPU 版本（最有效）
如果不需要 GPU 加速，可以使用 CPU 版本的 PyTorch，体积可以减小 50%：

```bash
# 卸载 GPU 版本
pip uninstall torch torchvision

# 安装 CPU 版本（更小）
pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
```

### 3. 使用虚拟环境打包（推荐）
在一个干净的虚拟环境中只安装必要的包：

```bash
# 创建新的虚拟环境
conda create -n yolo_pack python=3.10 -y
conda activate yolo_pack

# 只安装必要的包
pip install ultralytics PyQt5 opencv-python-headless pyinstaller

# 然后执行打包命令
```

### 4. 使用 UPX 压缩（可选）
下载 UPX 工具并添加到打包命令：

```bash
# 下载 UPX: https://upx.github.io/
# 在打包命令中添加
--upx-dir=C:\path\to\upx
```

### 5. 创建 spec 文件进行精细控制
生成并编辑 spec 文件以排除更多不需要的文件：

```bash
# 先生成 spec 文件
pyi-makespec --name=可见光成像叶片表面缺陷检测系统 --windowed pyqt5_detection_viewer.py

# 编辑生成的 .spec 文件，在 Analysis 部分添加：
excludes=[
    'matplotlib', 'pandas', 'scipy', 'tkinter',
    'jupyter', 'IPython', 'pytest', 'unittest',
    'PIL.ImageQt', 'tensorboard', 'setuptools'
],

# 使用 spec 文件打包
pyinstaller 可见光成像叶片表面缺陷检测系统.spec
```

## 预期体积对比

| 配置 | 预期体积 |
|------|---------|
| 原始命令（collect-all） | ~5GB |
| 优化命令（GPU版PyTorch） | ~800MB-1.2GB |
| 优化命令 + CPU版PyTorch | ~400-600MB |
| 优化命令 + CPU + UPX压缩 | ~300-500MB |

## 重要说明

⚠️ **100MB 对于包含 PyTorch 和 YOLO 的应用是不现实的目标**

原因：
- PyTorch 库本身：200-800MB（取决于 CPU/GPU 版本）
- OpenCV：50-100MB
- PyQt5：50-80MB
- YOLO 模型文件：6-50MB（取决于模型大小）
- 其他依赖：50-100MB

**建议的现实目标：**
- GPU 版本：500-800MB
- CPU 版本：300-500MB

## 执行步骤

1. 使用更新后的 `最终打包命令.txt` 中的命令
2. 如果体积仍然太大，尝试使用 CPU 版本的 PyTorch
3. 在干净的虚拟环境中打包
4. 如果需要进一步优化，使用 spec 文件进行精细控制

## 测试打包结果

打包完成后，确保测试所有功能：
- ✅ 模型加载
- ✅ 图像检测
- ✅ 视频检测  
- ✅ 摄像头检测
- ✅ 登录功能
- ✅ 结果保存

